---
layout: post
title: "DevOps实战：VMware管理员运维方法、工具及最佳实践"
description: ""
category: 
tags: [DevOps]
---

# 第1章　DevOps简介

DevOps是一种系统部署方法学，组织可以用它来改善项目部署的速度和质量。它不仅仅只是另一个流行词，传统的IT组织正在认真研究DevOps实践和工具对它们实现目标带来的帮助，这就是一个明证。DevOps只对云规模组织（如Netflix和PayPal）有好处吗？当然不是，DevOps实践对任何规模的组织都有好处。

本章包含如下主题：

    ·DevOps原则概述
    ·DevOps原则在组织中的实际运用
    ·磨练DevOps知识和技能的重要性

## 1.1　DevOps原则概述

DevOps包含组织互动和部署工具及实践的变化，主要强调识别和缓解生产率瓶颈。你们当中的一些人可能阅读过Gene Kim所著的《The Phoenix Project》，书中他将DevOps的重要原则归结为DevOps的三条道路：

    ·第一条道路：优化从开发到IT运营的工作流。
    ·第二条道路：缩短和放大反馈循环。
    ·第三条道路：鼓励试验，快速从故障中学习。

这些原则和John Willis及其他DevOps思想领袖所讨论的流行概念CAMS（文化、自动化、计量和共享）相符：

	·文化：故障不应该立即引起过失认定，改变团队成员对部署方法和故障响应的思维方式。
	·自动化：人工方法容易招致故障。使用能够以可靠的方式重复、快速部署环境的工具。
	·计量：监控和分析对于成功必不可少，否则，故障的根源分析就不可能实现。
	·共享：个人/团队独占信息，以维持地位提升或者团队依赖性的“摇滚明星”心态在IT文化中站不住脚。这种心态不会加快生产速度，而会降低生产速度。

这些想法中，有些可能需要管理层的权力才能推动变化。那么，它们对于作为IT部门中虚拟化专家的读者来说意味着什么？你如何帮助引导这种变化？

虚拟化专家处于一个独特的地位，能够帮助开发团队和运营团队保持一致。在融合式基础设施的世界中，我们在规划和部署虚拟基础设施时已经熟悉了多学科（计算、网络、存储、安全等）的协调。这种专业知识对于协调组织中的开发和IT运营团队至关重要。

不管我们部署虚拟基础设施有多快，企业项目的成功将取决于从开发迁移到生产的效率。

想象一场接力赛：如果团队没有预先准备（回顾旧的影片、训练交接棒、力量训练等），在赛场上就肯定会犯错（掉棒、选手相互绊倒等）。IT运营将会为误期而受到责备，“影子IT”的使用将更加盛行。

在前一段中我强调“预先”，是因为当开发团队完成敏捷发行过程时，再启动部署工作往往已经太迟了。如果你的一位或者多位团队成员成为开发组织的顾问，在整个“冲刺”过程中都和他们在一起工作，而不仅仅在发行的末期，会怎么样呢？我们将以下面讨论的一个虚构项目作为背景，说明这些方法。

例如，假定你的公司DevWidgets决定发行一个软件即服务（SaaS）解决方案，包含其集成开发环境（IDE）和源代码管理（SCM）软件解决方案（Taao项目）。目标是利用互联网，通过在线结对编程、代码评审网络会议等手段，培养地理上分散的团队成员之间的互动。

Taao项目是高级领导层确认为公司旗舰产品的重大举措。有些高管人员曾经阅读过《The Phoenix Project》，他们希望对该项目实施“DevOps工作”，因为他们对过去的发行安排感到不满。CEO甚至考虑建立专门的DevOps团队，全部配属新雇用的人员（因为人数越多，项目总是推进得越快，对吗？）。

开发和IT组织的经理们努力使高级领导层保持镇静，请求领导给出时间，并承诺在当月月末提交一项计划。在这方面你能提供什么帮助？下面几节我们将探索你可能采取的措施。

1.2　采用系统思维

系统思维意味着将涉及软件发行版本部署的所有团队当成一个紧密相连的单位，而不是日程安排相互冲突的多个分散团队。这些团队包括信息安全、运营、开发、质量保证（QA）、产品管理等。

注意　在我们的讨论中所提到的系统指的是经历整个软件开发生命期（规划、开发、QA、部署和维护）的任何项目，不管这些项目是供内部还是外部消费的。

1.2.1　改变团队的互动方式

我们将焦点放在第一件应该做的事：成为开发团队的顾问。和负责定期规划会议的开发团队领导（在敏捷的术语中称为产品负责人和敏捷教练）对话，要求加入他们的一些回忆。主动倾听可能需要基础设施采购/部署的任何团队目标或者可交付成果。下面的几段强调来自开发团队的需求/规格示例，说明了在这种会议期间你所能提供的反馈/专业意见。

·“我们需要用于客户源代码的长期数据存储。”

开发团队不一定直接说出他们需要一个新的磁盘阵列，甚至没有意识到需要采购存储设备。但是，对存储系统的认识会提示你，有必要和存储主题专家（SME）一起进行容量规划。

你还需要在开发人员讨论用户数据生命期管理时考虑不同的存储层次。

·“我们需要在生产环境中运行独立于客户使用实例的Taao项目实例。”

这立即让你想起附加虚拟网络或者虚拟防火墙的需求，这能够使生产和客户数据流量与内部流量分隔开。你还需要咨询信息安全团队，了解提供客户数据分离保证的审计过程。

·“在我们的最后一个发行周期中，代码在我的便携电脑上成功编译和运行，但是在部署到生产环境时崩溃。”

开发人员可能提出一个在之前的代码部署中遇到的问题，提交的代码在她的便携电脑上工作正常，但是在生产部署时发生故障。她的本地开发环境运行的是Ubuntu虚拟机（VM），和非军事区（DMZ）中的CentOS服务器上实施的安全补丁或者防火墙规则不匹配。所以，需要立即打补丁以满足最后限期（对于开发团队和运营团队都是一个漫长的夜晚）。你对Vagrant和Packer等环境构建工具和Puppet、Chef及Ansible等配置管理工具的认识，使你能够构建一个用于开发人员便携电脑且匹配生产服务器规格的标准测试环境。

由于开发团队领导了解了运营团队在发行周期早期为了缓解开发环境问题所做出的努力，你在协调与此努力相关的一些活动时就会更容易一些。首先，这意味着开发团队需要确保其成员不会将任务推给其他团队。（也就是说，“现在是周五下午5点了，我不知道代码能不能在生产环境中正常工作，但是无论如何，我都会把它提交到存储库！”）

某组织在最近的PuppetConf上发表讲话，分享其代码部署策略：当代码部署到生产环境时，编写代码的开发人员参与更改窗口期的轮班。这样，如果代码中出现任何复杂现象，他们可以立即协助运营团队查错和解决。坦率地说，这也使开发人员有动力编写更好的代码，避免在凌晨3点接到电话去修复缺陷。

在继续之前，对于可能阅读本书的经理，Jez Humble强烈建议：不要构建新的DevOps团队！雇用在DevOps方法学上有专业能力的开发人员、QA工程师、运营人员是个好主意，但是创建不同于组织其余团队的全新DevOps团队只会带来新的“竖井”，可能对你的目标造成反作用。相反，应该像前面提到的那样，继续更好地协调各个团队，使他们像一个团队那样思考和行动，而不是各自寻求自己的最大利益。

1.2.2　改变基础设施部署方法

数据中心的一些扰人而又常见的现象可能妨碍系统的进展：手工制作的“金映像”、雪花服务器和易碎箱。

服务器（不管是物理还是虚拟服务器）部署的常用方法是维护一组包含必要更新、补丁、设置等内容的操作系统配置，人工运用这些配置使系统立刻为部署做好准备。这些配置被称作“金映像”，传统上采用ISO形式，已经根据某个运行手册人工应用补丁。最近，金映像已经采用模板VM的形式保存。但是，老实说：金映像也可能生锈！

金映像本身没有什么问题。但是，构建它们的方式可能带来问题。如果人工构建，该过程可能是一个全职工作，必须跟踪模块更新、安全补丁等，然后重新配置ISO/模板VM供以后使用。必须有一种更有效的方法，也的确有！

使用第4~13章介绍的配置管理技术，可以自动构建映像。随着服务器配置更改并登记到Git（第3章中介绍）等存储库，Jenkins（参见第18章）等持续集成（CI）系统可以输出一个更新的金映像。CI系统可以使用Packer等工具生成用于Vagrant、虚拟化管理器和云提供商的模板VM。

Martin Fowler提出了“雪花服务器”的思路，雪花服务器是一台物理机器或者VM，最初是为了保持标准化的良好愿望。但是，不管是为了完成故障报告而进行快速修复、高管要求的特殊项目还是其他原因，这种服务器都变成高度定制的。这些特殊更改解决了短期问题，但是会造成长期的麻烦。当对这些服务器上的软件包升级时会发生什么？安全补丁甚至操作系统升级又会发生什么？

如何解决雪花服务器的问题？首先，我们通过登录到服务器命令行界面强制避免任何更改；不允许一次性执行前端和软件包更新工具或者更改配置文件。所有服务器更改都只能通过配置管理技术进行。

对于现有的雪花服务器，必须进行一些乏味而不必要的工作。首先，检查服务器配置，以便准确地知道需要修改的配置文件、需要安装的软件包和其他需要包含在配置管理脚本中的关键设置。多次迭代构建和测试服务器，每次都对配置管理脚本进行调整，直到测试环境与雪花服务器完全相同。将更改提交到源代码库，就可以拥有一个可在生产服务器无法恢复时使用的可重复构建过程。

易碎箱这一术语来源于Nassim Nicholas Taleb的《Antifragile》一书，描述了一台运行关键软件栈的物理或者虚拟服务器，每个人都害怕接触它，因为业务可能因此遭遇重大故障。通过许多支持电话/专业服务，这台服务器已经达到了一个稳定状态，糟糕的是，管理该服务器的SME离开了公司。

如果稳定性确实是个考虑因素，进行物理-虚拟转换或者虚拟-虚拟迁移到VMware vSphere平台是个好主意。这样，你可以利用分布式资源调度器（DRS）、存储DRS、高可用性（HA）等VMware基础设施可靠性机制。在服务器转换且拥有成功的业务持续性工作流（备份、快照）后，就可以考虑是否可以利用前面雪花服务器的弥补措施复制这一服务器。开发和QA工程师就可以很容易地构建一个测试环境而不接触易碎箱。

1.2.3　改变软件开发和部署方法

我们已经解决了基础设施部署的速度和质量问题，那么团队如何减少从开发、展示到生产阶段代码移动引起的缺陷？众所周知，在开发周期中越早发现缺陷，修复的代价就越低。这就是我们首先要有QA团队的原因。

但是，如果我们可以在代码移交给QA工程师之前就捕捉到缺陷，又会如何？这就是前面提到的持续集成系统的用途所在。我们后面会更详细地讨论CI，基本要点是，当你将源代码提交到存储库时，CI系统可以修改并设置为自动执行对提交代码的一系列单元测试。在过程结束时，可以构建一个软件包并自动分发给QA团队，实施他们的全面测试。

1.2.4　经常收集和响应有用的系统反馈并相应调整

系统思维的转变只有在有能力监控和分析系统性能时才能成功。业务的变化节奏似乎是指数级的，消费者对系统响应能力和正常运行时间有更高的预期，被动的问题解决方案不再成为选择；相反，你的团队必须在问题发生之前预测到它们，以维护系统稳定性。

日志分析可能是最重要的工具之一，尤其是在启用了二进制代码的调试选项时。如果你的环境由较多的服务器组成，就应该采用某种形式的自动化日志分析。这方面的选择很多，包括VMware vRealize Log Insight、Splunk甚至Logstash、Elasticsearch和Kibana等开源工具（第17章中介绍）。这些解决方案使系统管理员能够检查重复的事件与低下的性能关联。当团队更加熟悉这些工具，且更擅长识别问题时，系统的实用性就会提升。

1.3　增进DevOps知识和技能

一旦在系统思维和改进的系统验证上构建了很好的基础，团队对定期试验新功能就会更加自信。DevOps实践使开发人员能够分阶段逐步地投产各种功能。这样做的好处之一是，开发人员可以利用针对选择的客户的限定发行版本对新功能进行Beta测试，收集基础设施影响和用户接受度方面的指标。有效的日志分析方法能够在重大问题蔓延之前发现它们。

持续的学习和改进不只是用于新产品功能的部署：持续发展自己的技能、扩展知识集合也很重要。除了跟上VMware技术的最新、最杰出的发展之外，还要积极学习有利于和开发人员进行更有意义互动的新技能。学习公司使用的编程语言的基础知识，培养对敏捷过程的兴趣。和公司开发人员的沟通越有效，项目从开发到生产的迁移就越顺畅。

积极增进对“快速流程”的理解，Gene Kim用这个术语描述合理的产品开发和部署。这方面的最佳方法往往是参加有关DevOps实践和工具的聚会、会议、用户组（例如，DevOpsDays、DevOps企业峰会、PuppetConf和Chef Conf）。阅读来自思想领袖、关于这一主题的数据/博客帖子/推文，并在行业活动和社会化媒体上与其交流。

1.4　小结

我们已经确定了DevOps的概念和对组织的好处，下面我们将更仔细地研究有助于团队成功的一些工具。

参考文献：

[1] The Phoenix Project, by Gene Kim, Kevin Behr, and George Spafford

[2] "What Devops Means to Me", by John Willis: https://www.getchef.com/blog/2010/07/16/what-devops-means-to-me/


第2章　DevOps工具

有一些工具能够帮助团队采用DevOps技术。本章介绍这些工具，在本书后面，将用实操示例更详细地介绍。

本章包含如下主题：

·为成功而组织

·服务器部署

·配置管理

·持续集成

·日志分析

2.1　为成功而组织：看板

传统的运营团队任务管理通常涉及某种单据系统。故障单据很适合于跟踪问题，并在问题解决以后进行历史分析。故障单据系统的问题在于，它们给应该相关的任务之间的关联带来了困难。另一个挑战是生产交付瓶颈根源的识别。而且，工作者们可能无法看到其他人处理的故障单据，从而无法借助他人的专业知识。最后，管理工作过程、避免过度分配运营团队成员的最佳途径是什么？也就是说，如果运营团队总是专注于堆积如山的指派任务，他们何时才有时间改善系统，偿还技术债务呢？我们如何正确排定工作的优先级，考虑任务之间的依赖性？

看板（Kanban，字面翻译为“标记卡片”）系统有助于解决这些问题，以及其他的一些问题。这种方法是Taiichi Ohno在开发丰田制造系统时为了实现即时生产（JIT）目标而开发的，它通过检查制造过程不同步骤的流程，识别需要补救的瓶颈，使系统更加高效。具体的思路是，缓解瓶颈，就会将工作任务从在途状态带到完成状态。限制在途工作可以为工作者带来空闲时间，对制造过程进行改进（例如，在缓解旧瓶颈的同时识别和消除新瓶颈）。图2-1展示了制造过程的估计完成时间没有实现的例子。


图2-1　制造过程

随着工作流从原材料输入到制造过程，最后进入装配过程，我们可以看到估算的完成时间和实际不符。装配过程似乎有某些问题。在进一步调查中，工厂工人们可能发现在金属薄板上喷涂特种涂料的过程效率不高。例如，服务器面板制造过程的输入可能表现出没有正确应用涂料的信号，所以进行返工，导致整个过程的效率不高。如果喷涂过程中固定薄钢板的托架没有超载，输出产品的制造可能从一开始就是正常的，不需要太多的返工。

在前一个例子中，如果工人埋头修复没有正确喷涂的金属薄板，而没有去识别问题的真正根源，就会继续浪费精力。我们从来没有在IT运营工作流中看到这种问题，对吗？

你可能会觉得奇怪，我们为什么在关于DevOps工具的章节中讨论制造工程组织方法。但是，在成功地改变工作方式之前，我们必须用一种条理性的方法来安排工作、识别系统中的问题。

尽管看板是制造中的一个学科，但是通过David J.Anderson和其他人的努力，将精益的概念与丰田的看板方法相结合，在IT业流行起来。我们不对看板做全面介绍，但是将讨论有助于IT运营团队的关键点。

看板系统最重要的特征是工作过程管理。在新工作请求时分配所有IT运营人员会造成效率低下，这一点似乎有些违反直觉。但是，运营团队面对和制造团队类似的问题。例如，如果团队使用预先制作的ISO金映像构建服务器，如果金映像有一段时间没有更新，那么在需要人工更新应用程序和打补丁时就有可能出现错误。如果团队的管理者将重点主要放在满足服务器请求，以至于100%的工作人员都参与这类工作流，而没有寻找改善过程效率的方法，这样的情况还会持续。不过，人为的错误可能引起失败，重要的安全更新可能遗漏，容易遭到攻击的端口保持打开，必须加以补救才能确保服务器不会遭到攻击。团队可能习惯于这种低效的状态，管理层也对产量感到满意。但是，很多时间浪费在这种重复劳动上，这种状态被称作“技术负债”。

技术负债是在计划好的工作期间，由于错误或者效率低下造成的所有计划外工作。运营团队需要充分的时间进行系统改进，即使这一工作没有相关的具体可交付成果。我并不是为运营团队的“游手好闲”辩护（经理们可能这么想）。运营团队看上去似乎很高效地服务于当前的客户需求，但是，当公司希望很快增加运营规模时会发生什么情况？现有的工作流不能停止，在你遇到没有准备好解决方案的伸缩性问题时，就要对系统进行改进。如果现在已经遇到某些这类问题，积极调查并缓解瓶颈，可以帮助你增进效率。

看板的另一个重要特征是工作流自始至终的可视化。最流行的展示方式是看板图，它可以采用物理或者数字形式。图2-2展示了可供第1章介绍的DevWidgets公司使用的看板图示例。


图2-2　在线看板图

看板图的思路是每个任务由一张索引卡或者即时贴（也被称作看板）表示，在看板图左侧的“积压工作”（Backlog）分类下排队。“积压工作”和“完成”（Done）之间的栏目代表工作过程。在工作任务移出积压工作栏时，在它们上面放置工作过程（WIP）限制（例如，4/4和5/5）。在一张看板移到工作流的下一栏之前，不应该在WIP栏上放置其他工作。

图2-2展示了不同的任务行——也称为泳道。这些泳道对应于不同类型的工作（例如，新产品、维护和缺陷）。正确地为工作分类有助于优先级的排定。

团队第一次开始使用看板时，WIP限制可以根据过去的经验设置。以后，随着瓶颈的缓解和团队效率的改进，这些限制可以更改，这样团队就可以随着时间的推移不断寻求工作流的改善。记住，目标是持续改善，同时避免团队100%投入新的任务。如果你对在团队中引入看板方法感兴趣，咨询该学科从业者中的佼佼者（如Dominica DeGrandis或精益看板大学认可的从业者）是值得的。你的看板图不一定要和图2-2中的相似，目标是开发对团队有意义的清晰、实用系统。


